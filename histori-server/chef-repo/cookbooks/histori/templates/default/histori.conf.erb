<VirtualHost *:443>

ServerName <%=@server_name%>

DocumentRoot <%=@doc_root%>
<Directory <%=@doc_root%>>
  Require all granted
</Directory>

SSLEngine on
SSLCertificateFile      /etc/ssl/certs/<%=@cert_name%>.pem
SSLCertificateKeyFile   /etc/ssl/private/<%=@cert_name%>.key
SSLCertificateChainFile /etc/ssl/certs/StartSslIntermediate.crt
Header add Strict-Transport-Security: "max-age=15768000;includeSubdomains"

# Add favicons after every <head>, and copyright notice before every </body>
ProxyPass /__favicon.html !
ProxyPass /__footer.html !

RewriteEngine on
RewriteRule ^/__favicon.html - [END]
RewriteRule ^/__footer.html - [END]

<Location />
  Options +Includes
  FilterDeclare HISTORI_HEAD_SUBST
  FilterProvider HISTORI_HEAD_SUBST SUBSTITUTE "%{CONTENT_TYPE} =~ m|^text/html|"
  SUBSTITUTE 's|<head>|<head><!--#include virtual="/__favicon.html" -->|ni'
  SUBSTITUTE 's|</body>|<!--#include virtual="/__footer.html" --></body>|ni'

  FilterDeclare HISTORI_HEAD_TAG
  FilterProvider HISTORI_HEAD_TAG INCLUDES "%{CONTENT_TYPE} =~ m|^text/html|"

  FilterDeclare INFLATE
  FilterDeclare DEFLATE

  FilterProvider INFLATE INFLATE "%{req:Accept-Encoding} =~ /gzip/"
  FilterProvider DEFLATE DEFLATE "%{req:Accept-Encoding} =~ /gzip/"

  FilterChain INFLATE HISTORI_HEAD_SUBST HISTORI_HEAD_TAG DEFLATE
</Location>

# these will work in a pinch and are more reliable, if the above ever breaks due to JavaScript madness
#ProxyPass /legal http://127.0.0.1:<%=@api_port%>/api/configs/legal
#ProxyPassReverse /legal http://127.0.0.1:<%=@api_port%>/api/configs/legal

ProxyPass / http://127.0.0.1:<%=@api_port%>/
ProxyPassReverse / http://127.0.0.1:<%=@api_port%>/

ErrorLog ${APACHE_LOG_DIR}/<%=@server_name%>_error.log
CustomLog ${APACHE_LOG_DIR}/<%=@server_name%>_access.log combined env=!dontlog
CustomLog ${APACHE_LOG_DIR}/<%=@server_name%>.log combined

BrowserMatch "MSIE [2-6]" \
nokeepalive ssl-unclean-shutdown \
downgrade-1.0 force-response-1.0
# MSIE 7 and newer should be able to use keepalive
BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

</VirtualHost>
